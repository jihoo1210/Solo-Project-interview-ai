# 토큰 삭제 vs 사용 처리 (Soft Delete)

> 작성일: 2024-12-13
> Phase: 2 (인증 시스템)

---

## 1. 질문

이메일 인증 토큰을 사용 후 **삭제하지 않고 `used=true`로 처리**하는 이유는?

---

## 2. 두 가지 방식 비교

| 방식 | 장점 | 단점 |
|------|------|------|
| **삭제 (Hard Delete)** | DB 용량 절약 | 이력 추적 불가 |
| **사용 처리 (Soft Delete)** | 이력 추적 가능, 보안 분석 가능 | DB 용량 증가 |

---

## 3. 사용 처리(Soft Delete)의 장점

### 3.1 보안 감사 (Audit)
- 누가, 언제, 어떤 토큰으로 인증했는지 기록
- 이상 징후 탐지 (예: 동일 IP에서 다수 인증 시도)
- 보안 사고 발생 시 추적 가능

### 3.2 고객 지원
- "인증 메일 받았는데 안 돼요" → 기록 조회 가능
- 토큰 발급/사용 시점 확인
- 문제 원인 파악 용이

### 3.3 재사용 방지 증명
- 토큰이 이미 사용되었음을 명확히 증명
- 중복 인증 시도 차단

---

## 4. 실무에서 선택 기준

| 방식 | 사용처 |
|------|--------|
| **사용 처리** | 보안이 중요한 서비스 |
| **삭제** | 단순한 서비스, 또는 주기적 배치로 오래된 데이터 삭제 |
| **삭제 + 별도 로그 테이블** | 이력은 남기되 원본은 삭제 |

---

## 5. 용량 문제 해결

DB 용량이 문제되면 **스케줄러로 오래된 레코드 삭제**:

```java
@Scheduled(cron = "0 0 3 * * *")  // 매일 새벽 3시
public void cleanupOldTokens() {
    LocalDateTime threshold = LocalDateTime.now().minusDays(30);
    emailVerificationRepository.deleteByCreatedAtBefore(threshold);
}
```

- 30일 이상 된 토큰만 삭제
- 최근 이력은 유지

---

## 6. 현재 프로젝트 적용

```java
// EmailVerification.java
public void markAsUsed() {
    this.used = true;
}

// AuthService.java
emailVerification.markAsUsed();  // 삭제 대신 사용 처리
```

**이유**: 보안과 추적성 우선
