# 보안 로그 및 알림 구현 방법

## 질문
> 보안 로그나 알림은 어떻게 확인하나요?

---

## 1. 보안 로그 확인 방법

### 방법 1: 콘솔/파일 로그 (가장 기본)

```java
// 컨트롤러나 서비스에서
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@RestController
public class AuthController {

    private static final Logger log = LoggerFactory.getLogger(AuthController.class);

    @PostMapping("/login")
    public ApiResponse<?> login(@RequestBody LoginRequest request) {
        // 로그인 성공 시
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        WebAuthenticationDetails details = (WebAuthenticationDetails) auth.getDetails();

        log.info("[로그인 성공] 사용자: {}, IP: {}, 시간: {}",
            auth.getName(),
            details.getRemoteAddress(),
            LocalDateTime.now());

        // 출력: [로그인 성공] 사용자: test@email.com, IP: 192.168.0.100, 시간: 2024-12-12T15:30:00
    }
}
```

### 로그 레벨

```yaml
# application.yml
logging:
  level:
    root: INFO
    com.interviewai: DEBUG              # 우리 코드는 DEBUG
    org.springframework.security: DEBUG  # Security 상세 로그
  file:
    name: logs/application.log          # 파일로 저장
```

### 로그 파일 확인

```bash
# 실시간 로그 확인
tail -f logs/application.log

# 특정 키워드 검색
grep "로그인 성공" logs/application.log
grep "192.168.0.100" logs/application.log
```

---

## 2. 보안 이벤트 저장 (DB)

### 로그인 기록 엔티티

```java
@Entity
@Table(name = "login_history")
public class LoginHistory {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

    private String ipAddress;
    private String userAgent;
    private boolean success;        // 로그인 성공/실패
    private String failReason;      // 실패 사유
    private LocalDateTime loginAt;
}
```

### 로그인 시 기록 저장

```java
@Service
@RequiredArgsConstructor
public class AuthService {

    private final LoginHistoryRepository loginHistoryRepository;

    public void recordLogin(User user, HttpServletRequest request, boolean success, String failReason) {
        LoginHistory history = LoginHistory.builder()
            .user(user)
            .ipAddress(request.getRemoteAddr())
            .userAgent(request.getHeader("User-Agent"))
            .success(success)
            .failReason(failReason)
            .loginAt(LocalDateTime.now())
            .build();

        loginHistoryRepository.save(history);
    }
}
```

### 관리자 페이지에서 조회

```java
@GetMapping("/admin/login-history")
public List<LoginHistory> getLoginHistory(
    @RequestParam(required = false) String email,
    @RequestParam(required = false) String ip) {

    // 특정 사용자 로그인 기록
    // 특정 IP에서의 모든 로그인 시도
    // 실패한 로그인만 필터링 등
}
```

---

## 3. 실시간 알림 구현

### 방법 1: 이메일 알림

```java
@Service
@RequiredArgsConstructor
public class SecurityAlertService {

    private final JavaMailSender mailSender;

    public void sendLoginAlert(User user, String ip, String location) {
        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(user.getEmail());
        message.setSubject("[보안 알림] 새로운 위치에서 로그인");
        message.setText(String.format(
            "안녕하세요 %s님,\n\n" +
            "새로운 위치에서 로그인이 감지되었습니다.\n\n" +
            "IP: %s\n" +
            "위치: %s\n" +
            "시간: %s\n\n" +
            "본인이 아니라면 즉시 비밀번호를 변경해주세요.",
            user.getNickname(), ip, location, LocalDateTime.now()
        ));

        mailSender.send(message);
    }
}
```

### 방법 2: Slack/Discord 알림 (관리자용)

```java
@Service
public class SlackAlertService {

    @Value("${slack.webhook-url}")
    private String webhookUrl;

    public void sendSecurityAlert(String message) {
        RestTemplate restTemplate = new RestTemplate();

        Map<String, String> payload = Map.of("text", message);

        restTemplate.postForEntity(webhookUrl, payload, String.class);
    }
}

// 사용 예시
slackAlertService.sendSecurityAlert(
    ":warning: [보안 경고] 5회 이상 로그인 실패\n" +
    "IP: 192.168.0.100\n" +
    "시도 계정: test@email.com"
);
```

### 방법 3: 푸시 알림 (모바일 앱)

```java
// Firebase Cloud Messaging 등 사용
fcmService.sendNotification(
    user.getDeviceToken(),
    "새로운 로그인 감지",
    "192.168.0.100에서 로그인되었습니다."
);
```

---

## 4. 의심 활동 자동 감지

### 로그인 실패 횟수 체크

```java
@Service
@RequiredArgsConstructor
public class LoginAttemptService {

    private final Map<String, Integer> attemptCache = new ConcurrentHashMap<>();
    private static final int MAX_ATTEMPTS = 5;

    public void loginFailed(String ip) {
        int attempts = attemptCache.getOrDefault(ip, 0) + 1;
        attemptCache.put(ip, attempts);

        if (attempts >= MAX_ATTEMPTS) {
            // 알림 발송
            slackAlertService.sendSecurityAlert(
                "IP " + ip + "에서 " + attempts + "회 로그인 실패"
            );
        }
    }

    public boolean isBlocked(String ip) {
        return attemptCache.getOrDefault(ip, 0) >= MAX_ATTEMPTS;
    }

    public void loginSucceeded(String ip) {
        attemptCache.remove(ip);  // 성공하면 카운트 리셋
    }
}
```

### 새로운 IP 감지

```java
public void checkNewLocation(User user, String currentIp) {
    String lastIp = user.getLastLoginIp();

    if (lastIp != null && !lastIp.equals(currentIp)) {
        // 다른 IP에서 로그인
        securityAlertService.sendLoginAlert(user, currentIp, "새로운 위치");
    }

    // 마지막 IP 업데이트
    user.setLastLoginIp(currentIp);
    userRepository.save(user);
}
```

---

## 5. Spring Boot Actuator (모니터링)

### 의존성 추가

```gradle
// build.gradle
implementation 'org.springframework.boot:spring-boot-starter-actuator'
```

### 설정

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health, info, metrics, loggers
  endpoint:
    health:
      show-details: always
```

### 확인 방법

```
http://localhost:8080/actuator/health   # 서버 상태
http://localhost:8080/actuator/metrics  # 메트릭 (요청 수, 에러 수 등)
http://localhost:8080/actuator/loggers  # 로그 레벨 동적 변경
```

---

## 6. 요약

| 방법 | 용도 | 난이도 |
|------|------|--------|
| **콘솔/파일 로그** | 개발 중 디버깅 | 쉬움 |
| **DB 저장** | 로그인 기록 관리 | 보통 |
| **이메일 알림** | 사용자에게 보안 알림 | 보통 |
| **Slack/Discord** | 관리자 실시간 알림 | 쉬움 |
| **Actuator** | 서버 상태 모니터링 | 쉬움 |

### 우리 프로젝트 권장 순서

1. **지금**: 콘솔 로그 (`log.info()`)
2. **Phase 2 완료 후**: 로그인 기록 DB 저장
3. **운영 단계**: 이메일 알림 + Slack 연동

---

## 관련 파일
- `global/security/jwt/JwtAuthenticationFilter.java`
- `application.yml` (logging 설정)
