# 이메일 인증 토큰 설계

> 작성일: 2024-12-13
> Phase: 2 (인증 시스템)

---

## 1. 이메일 인증 토큰이란?

JWT 토큰과는 다른, **이메일 소유 확인용 일회성 토큰**입니다.

### JWT vs 이메일 인증 토큰

| 구분 | JWT 토큰 | 이메일 인증 토큰 |
|------|----------|-----------------|
| 용도 | API 인증/인가 | 이메일 소유 확인 |
| 저장 위치 | 클라이언트 (localStorage) | DB (`EmailVerification` 테이블) |
| 형태 | 서명된 JSON (Header.Payload.Signature) | 랜덤 문자열 (UUID 등) |
| 만료 | 1시간 ~ 7일 | 보통 10분 ~ 24시간 |

---

## 2. 이메일 인증 흐름

```
1. 회원가입 요청
2. User 저장
3. 랜덤 토큰 생성 (UUID 또는 숫자)
4. EmailVerification 테이블에 저장 (user_id, token, expires_at)
5. 이메일 발송: "https://도메인/verify?token=abc123..."
6. 사용자가 링크 클릭
7. 서버에서 token으로 EmailVerification 조회
8. EmailVerification.getUser()로 해당 User 획득
9. 유효하면 User.emailVerified = true 처리
```

---

## 3. 토큰으로 사용자 식별하는 방법

### Q: 토큰만으로 어떻게 사용자를 구별하나요?

`EmailVerification` 엔티티에 **User 참조**가 있기 때문입니다:

```
EmailVerification
├── id
├── user (ManyToOne) ← User와 연결됨
├── token
├── expiresAt
└── used
```

토큰 조회 시 `findByToken(token)` → 해당 레코드의 `user` 필드로 사용자 획득

### Q: SecurityContext는 필요 없나요?

이메일 인증은 **비로그인 상태**에서 진행되므로, SecurityContext 불필요.

| 상황 | SecurityContext 필요 여부 |
|------|--------------------------|
| 이메일 인증 링크 클릭 | ❌ (로그인 안 한 상태) |
| 로그인 후 API 호출 | ✅ (인증된 사용자 정보 필요) |

---

## 4. UUID란?

**UUID (Universally Unique Identifier)** - 전 세계적으로 고유한 식별자

### 형태
```
550e8400-e29b-41d4-a716-446655440000
```
- 32자리 16진수 + 4개의 하이픈 = 총 36자리

### 왜 중복이 거의 없나요?

| 비교 | 6자리 숫자 | UUID |
|------|-----------|------|
| 경우의 수 | 10^6 = **100만** | 2^122 ≈ **5.3 × 10^36** |
| 중복 확률 | 100만 명 중 1명과 같을 확률 | 사실상 불가능 |

### Java에서 생성
```java
UUID.randomUUID().toString()
// 결과: "550e8400-e29b-41d4-a716-446655440000"
```

---

## 5. 토큰 방식 비교

### 방식 1: UUID만 사용 (권장)

```
http://localhost:8080/api/v1/auth/verify-email?token=550e8400-e29b-41d4-a716-446655440000
```

| 장점 | 단점 |
|------|------|
| URL이 깔끔 | 토큰이 길어짐 |
| 이메일 노출 없음 | - |
| 보안성 높음 | - |

### 방식 2: 이메일 + 짧은 토큰

```
http://localhost:8080/api/v1/auth/verify-email?email=user@example.com&token=482910
```

| 장점 | 단점 |
|------|------|
| 토큰이 짧음 | URL에 이메일 노출 |
| 중복 문제 해결 | 브라우저 히스토리에 이메일 남음 |
| - | 로그 파일에 이메일 기록됨 |

### 실무에서 많이 쓰는 방식

| 방식 | 사용처 |
|------|--------|
| **UUID만** | 대부분의 서비스 (GitHub, Google 등) |
| **이메일 + 짧은 코드** | 이메일에서 직접 코드 입력하는 경우 (OTP 형태) |

---

## 6. 결론

- **보안 우선**: UUID 방식 권장
- **사용자 편의 우선**: 이메일 + 짧은 코드 (OTP 형태)

현재 프로젝트는 **UUID 방식**으로 진행.
