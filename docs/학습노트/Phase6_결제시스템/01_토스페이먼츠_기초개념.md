# 토스페이먼츠 기초 개념

## 1. 토스페이먼츠란?

토스페이먼츠는 토스에서 제공하는 결제 PG(Payment Gateway) 서비스입니다.

### 주요 특징
- 간편한 연동 (SDK 제공)
- 다양한 결제 수단 지원 (카드, 계좌이체, 가상계좌, 간편결제 등)
- 테스트 모드 제공 (실제 결제 없이 테스트 가능)
- 정기결제(빌링) 지원

## 2. 인증 키 종류

토스페이먼츠에서 발급받는 키는 두 종류가 있습니다.

### Client Key (클라이언트 키)
```
test_ck_xxx...
live_ck_xxx...
```
- **용도**: 프론트엔드에서 SDK 초기화
- **보안**: 노출되어도 비교적 안전 (결제창 호출만 가능)
- **위치**: 프론트엔드 코드에서 사용

### Secret Key (시크릿 키)
```
test_sk_xxx...
live_sk_xxx...
```
- **용도**: 백엔드에서 결제 승인/취소 등 API 호출
- **보안**: 절대 노출되면 안 됨!
- **위치**: 백엔드 환경변수에만 저장

## 3. 결제 방식 비교

### 일반 결제 (단건 결제)
```
사용자 → 결제창 → 결제 완료 → 끝
```
- 한 번 결제하면 끝
- 매번 결제창을 통해 결제 정보 입력 필요

### 정기결제 (빌링키 방식)
```
최초: 사용자 → 카드 등록 → 빌링키 발급 → 첫 결제
이후: 서버 → 빌링키로 자동 결제 (결제창 없음)
```
- 구독 서비스에 적합
- 한 번 카드 등록하면 자동으로 결제 가능

## 4. 빌링키(Billing Key)란?

빌링키는 카드 정보를 대체하는 토큰입니다.

### 특징
- 카드번호, 유효기간 등을 직접 저장하지 않음
- 빌링키만 있으면 결제 가능
- PCI-DSS 준수 (보안 규정)

### 발급 과정
```
1. 프론트엔드: requestBillingKeyAuth() 호출
2. 사용자: 토스 결제창에서 카드 등록
3. 토스: authKey를 successUrl로 전달
4. 백엔드: authKey로 빌링키 발급 API 호출
5. 토스: billingKey 반환
6. 백엔드: billingKey 저장 및 결제 실행
```

## 5. Customer Key란?

Customer Key는 사용자를 식별하는 고유 키입니다.

### 용도
- 동일 사용자의 여러 카드를 관리
- 결제 내역 조회
- 빌링키와 연결

### 생성 규칙
```java
// UUID 사용 권장
String customerKey = UUID.randomUUID().toString();

// 또는 사용자 ID 기반
String customerKey = "user_" + userId;
```

## 6. 테스트 vs 운영 환경

### 테스트 환경
- 키 접두사: `test_ck_...`, `test_sk_...`
- 실제 결제 없음
- 테스트용 카드번호 사용

### 운영 환경
- 키 접두사: `live_ck_...`, `live_sk_...`
- 실제 결제 발생
- 사업자 심사 필요

### 테스트 카드 정보
```
카드번호: 4330000000000007
유효기간: 아무 미래 날짜
CVC: 아무 3자리
비밀번호: 아무 2자리
```

## 7. API 응답 구조

### 성공 응답
```json
{
  "mId": "tgen_...",
  "billingKey": "tviva...",
  "customerKey": "...",
  "authenticatedAt": "2025-12-17T12:00:00+09:00",
  "method": "카드",
  "card": {
    "issuerCode": "11",
    "acquirerCode": "11",
    "number": "433012******0007",
    "cardType": "신용",
    "ownerType": "개인"
  }
}
```

### 에러 응답
```json
{
  "code": "INVALID_CARD_NUMBER",
  "message": "유효하지 않은 카드번호입니다."
}
```

## 8. 주요 API 엔드포인트

| 용도 | Method | URL |
|------|--------|-----|
| 빌링키 발급 | POST | /v1/billing/authorizations/issue |
| 빌링키 결제 | POST | /v1/billing/{billingKey} |
| 결제 조회 | GET | /v1/payments/{paymentKey} |
| 결제 취소 | POST | /v1/payments/{paymentKey}/cancel |

## 9. 보안 주의사항

### DO (해야 할 것)
- Secret Key는 환경변수로만 관리
- HTTPS 사용
- 결제 금액 서버에서 검증

### DON'T (하면 안 되는 것)
- Secret Key를 코드에 하드코딩
- 프론트엔드에서 결제 금액 결정
- 카드번호 직접 저장

## 10. 참고 자료

- [토스페이먼츠 개발자 센터](https://developers.tosspayments.com/)
- [정기결제 가이드](https://docs.tosspayments.com/guides/v2/billing)
- [API 레퍼런스](https://docs.tosspayments.com/reference)
